name: AbeBooks Auto Sync

on:
  schedule:
    # Ejecutar cada 6 horas: 2am, 8am, 2pm, 8pm UTC
    - cron: "0 2,8,14,20 * * *"
  workflow_dispatch: # Permite ejecuciÃ³n manual desde GitHub

jobs:
  upload-inventory:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Check if auto-sync is enabled (only for scheduled runs)
      - name: Check Auto-Sync Status
        if: github.event_name == 'schedule'
        id: check-sync
        run: |
          RESPONSE=$(curl -s "${{ secrets.SUPABASE_FUNCTION_URL }}/check-ftps-enabled" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}")

          # Debug response
          echo "Function Response: $RESPONSE"

          # Handle potential double-encoded JSON or direct object
          ENABLED=$(echo "$RESPONSE" | jq -r 'if type=="string" then (try fromjson catch {}) else . end | .enabled')

          # Default to true if parsing fails but we got something? No, explicit safety.
          echo "Auto-sync enabled: $ENABLED"

          if [ "$ENABLED" != "true" ]; then
            echo "Auto-sync is disabled or check failed. Skipping sync."
            exit 0
          fi

      # Log sync start
      - name: Log Sync Start
        id: log-start
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          curl -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/abebooks_sync_log" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation" \
            -d "{
              \"sync_date\": \"$TIMESTAMP\",
              \"status\": \"running\",
              \"workflow_run_id\": \"${{ github.run_id }}\"
            }"

      - name: Install Dependencies
        run: npm install basic-ftp

      - name: Run AbeBooks Upload
        id: upload
        env:
          ABEBOOKS_USERNAME: ${{ secrets.ABEBOOKS_USERNAME }}
          ABEBOOKS_API_KEY: ${{ secrets.ABEBOOKS_API_KEY }}
          SUPABASE_FUNCTION_URL: ${{ secrets.SUPABASE_FUNCTION_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          START_TIME=$(date +%s)
          OUTPUT=$(node src/scripts/abebooks-upload.js)
          echo "$OUTPUT"
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "DURATION=$DURATION" >> $GITHUB_OUTPUT

          # Extract book count from script output
          BOOK_COUNT=$(echo "$OUTPUT" | grep "BOOK_COUNT=" | cut -d'=' -f2)
          echo "BOOK_COUNT=$BOOK_COUNT" >> $GITHUB_OUTPUT

      - name: Log Sync Success
        if: success()
        run: |
          # Get book count from upload step output
          BOOK_COUNT="${{ steps.upload.outputs.BOOK_COUNT }}"

          if [ -z "$BOOK_COUNT" ] || [ "$BOOK_COUNT" = "0" ]; then
            # Fallback check for txt file
            if [ -f "src/scripts/temp_abebooks_inventory.txt" ]; then
              BOOK_COUNT=$(wc -l < src/scripts/temp_abebooks_inventory.txt)
              BOOK_COUNT=$((BOOK_COUNT - 1))
            else
              echo "Warning: No book count found and TXT file missing"
              BOOK_COUNT=0
            fi
          fi

          echo "Books exported: $BOOK_COUNT"

          # Update the running log entry to success
          curl -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/abebooks_sync_log?workflow_run_id=eq.${{ github.run_id }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation" \
            -d "{
              \"status\": \"success\",
              \"books_exported\": $BOOK_COUNT,
              \"duration_seconds\": ${{ steps.upload.outputs.DURATION }}
            }"

      # Log sync error
      - name: Log Sync Error
        if: failure()
        run: |
          ERROR_MSG="Workflow failed at step: ${{ job.status }}"

          curl -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/abebooks_sync_log?workflow_run_id=eq.${{ github.run_id }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation" \
            -d "{
              \"status\": \"error\",
              \"error_message\": \"$ERROR_MSG\"
            }"
